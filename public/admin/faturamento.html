<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AFUJF – Admin • Faturamento</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{
      --g1:#12c26d; --g2:#0ea5a7; --g3:#1366d6;
      --title:#0c3a62; --muted:#6b82a3;
      --bd:#d8e6f8;
    }

    /* Fundo */
    body{
      background:
        radial-gradient(1400px 800px at -10% -10%, #20c07a22, transparent 60%),
        radial-gradient(1200px 700px at 110% -20%, #0ea5a733, transparent 65%),
        linear-gradient(180deg, #f7fbff 0%, #eaf3ff 100%);
    }

    /* ===== Launcher / Navbar ===== */
    .corner-launcher{
      position:fixed; top:.75rem; left:.75rem; width:68px; height:68px; border:0; border-radius:35px;
      background:linear-gradient(150deg,var(--g1),var(--g2) 45%,var(--g3));
      display:grid; place-items:center; color:#fff; cursor:pointer; z-index:1061;
      box-shadow:0 18px 38px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.22);
      transition:transform .15s, box-shadow .2s, opacity .2s; -webkit-tap-highlight-color:transparent;
    }
    .corner-launcher:hover{ transform:translateY(-2px); box-shadow:0 24px 44px rgba(0,0,0,.32), inset 0 1px 0 rgba(255,255,255,.22); }
    .corner-launcher.hidden{ opacity:0; transform:translate(-10px,-10px) scale(.96); pointer-events:none; }
    .af-badge{ width:48px; height:48px; border-radius:50%; object-fit:cover; display:block; box-shadow:0 12px 26px rgba(0,0,0,.35); }

    .offcanvas-afujf{
      width:340px; color:#fff; border-right:0;
      background: linear-gradient(180deg, var(--g1) 0%, var(--g2) 40%, var(--g3) 100%);
      box-shadow: 6px 0 26px rgba(0,0,0,.35);
    }
    .offcanvas-afujf .offcanvas-header{ border-bottom:1px solid rgba(255,255,255,.15); }
    .brand-badge-img{ width:44px; height:44px; border-radius:50%; object-fit:cover; box-shadow:0 8px 18px rgba(0,0,0,.35); }
    .brand-title-img{ max-height:28px; filter:drop-shadow(0 2px 6px rgba(0,0,0,.25)); }

    .menu-list{ list-style:none; margin:0; padding:.25rem 0; }
    .menu-link{
      display:flex; align-items:center; gap:.9rem; color:#fff; text-decoration:none;
      padding:.9rem 1rem; border-radius:14px; margin:.2rem 0;
      transition: background .2s, transform .15s, box-shadow .2s;
    }
    .menu-link:hover{ background:rgba(255,255,255,.10); transform:translateX(3px); box-shadow:0 10px 20px rgba(0,0,0,.25); }
    .menu-link.active{ background:rgba(255,255,255,.16); box-shadow:0 14px 32px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.25); }
    .menu-divider{ height:1px; background:rgba(255,255,255,.18); margin:.75rem 0 1rem; border-radius:2px; }

    .admin-block{
      border-top:1px solid rgba(255,255,255,.14); margin-top:1rem; padding-top:1rem;
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
    }
    .admin-badge{
      width:36px; height:36px; border-radius:10px; display:grid; place-items:center; color:#fff;
      background: linear-gradient(150deg,var(--g3),#0e8bd6); box-shadow:0 8px 18px rgba(0,0,0,.28);
    }

    /* ===== Conteúdo ===== */
    main{ padding:110px 16px 72px; }
    .container-narrow{ max-width:1200px; margin:0 auto; }

    .hero{ display:flex; align-items:flex-end; gap:14px; margin-bottom:18px; }
    .hero-chip{
      width:56px; height:56px; border-radius:18px; display:grid; place-items:center; color:#fff; font-size:1.35rem;
      background:linear-gradient(150deg,var(--g1),var(--g2) 45%,var(--g3));
      box-shadow:0 12px 26px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.25);
    }
    .hero h1{ font-size: clamp(1.2rem, 4vw, 1.9rem); margin:0; color:#0c3a62; font-weight:900; }
    .hero small{ color:#6b82a3; display:block; margin-top:2px; }

    /* KPIs */
    .kpi-grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-bottom:14px; }
    @media (min-width:768px){ .kpi-grid{ grid-template-columns: repeat(6, 1fr); } }
    .kpi{
      background:#ffffffd9; backdrop-filter: blur(6px);
      border-radius:16px; padding:14px; box-shadow:0 18px 34px rgba(12,52,100,.10);
      display:flex; align-items:center; gap:12px; min-height:86px;
    }
    .kpi-ico{
      width:44px; height:44px; border-radius:12px; display:grid; place-items:center; color:#fff; font-size:1.2rem;
      background:linear-gradient(150deg,var(--g1),var(--g2) 45%,var(--g3));
      box-shadow:0 10px 20px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.25);
      animation:pulse 2.2s ease-in-out infinite;
    }
    @keyframes pulse{ 0%,100%{ transform:scale(1)} 50%{ transform:scale(1.06)} }
    .kpi-val{ font-weight:900; color:#103a63; font-size:1.05rem; }
    .kpi-sub{ color:#6a86a7; font-size:.88rem; margin-top:-2px; }

    /* ===== Botões (pill + tamanhos consistentes) ===== */
    .btn-pill{ border-radius:999px !important; }
    .btn-lgx{ padding:.65rem 1.05rem; font-weight:800; }
    .btn-mdx{ padding:.55rem .9rem; font-weight:800; }
    .btn-icon{ width:40px; height:40px; display:grid; place-items:center; padding:0; }

    .btn-grad{
      border:0; color:#fff;
      background:linear-gradient(150deg,var(--g1),var(--g2) 45%,var(--g3));
      box-shadow:0 12px 24px rgba(0,0,0,.14);
      transition:filter .15s, transform .15s;
    }
    .btn-grad:hover{ filter:brightness(1.03); transform:translateY(-1px); }

    .btn-ghost{
      border:1px solid var(--bd); background:#fff; color:#24496f;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
      transition:background .15s, transform .15s, border-color .15s;
    }
    .btn-ghost:hover{ background:#f7fbff; transform:translateY(-1px); border-color:#cfe0f3; }

    /* ===== Toolbar limpa ===== */
    .toolbar{
      position:sticky; top:10px; z-index:1020;
      background:#ffffffd9; backdrop-filter: blur(10px);
      border-radius:18px; padding:12px; box-shadow:0 18px 36px rgba(12,52,100,.10);
      display:flex; flex-direction:column; gap:10px; margin-bottom:14px; border:1px solid #edf2fb;
    }
    .toolbar-header{ display:flex; gap:10px; align-items:center; }
    .toolbar-actions{ display:flex; gap:8px; align-items:center; }

    .search-wrap{ position:relative; flex:1; }
    .search-wrap .bi-search{ position:absolute; top:50%; left:12px; transform:translateY(-50%); color:#97aac3; }
    .search-input{
      padding-left:40px; border:1px solid var(--bd); border-radius:999px; height:44px;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
    }

    /* Abas de status */
    .status-tabs{ gap:8px; overflow:auto; scrollbar-width:none; }
    .status-tabs::-webkit-scrollbar{ display:none; }
    .status-tabs .nav-link{
      border-radius:999px; padding:.48rem .9rem; font-weight:800; color:#2a4a74; background:#f1f7ff; border:1px solid #d9e8fb;
    }
    .status-tabs .nav-link.active{ color:#0b5ed7; background:#e6f1ff; border-color:#c8e0ff; }
    .status-tabs .badge{ font-weight:800; }

    /* Collapse filtros */
    .filters-toggle{
      display:flex; align-items:center; gap:.45rem; font-weight:800; color:#24496f; cursor:pointer;
      border:1px solid var(--bd); background:#fff; padding:.5rem .85rem; border-radius:999px;
    }
    .filters-toggle i{ transition:transform .2s; }
    .filters-toggle[aria-expanded="true"] i{ transform:rotate(180deg); }

    .filters-body{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width:1100px){ .filters-body{ grid-template-columns: 220px 1fr auto; align-items:center; } }

    .segmented{
      display:inline-flex; border:1px solid var(--bd); border-radius:999px; overflow:hidden; background:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .segmented .seg{
      padding:.5rem .9rem; font-weight:800; color:#24496f; cursor:pointer; user-select:none;
    }
    .segmented .seg + .seg{ border-left:1px solid var(--bd); }
    .segmented .seg.active{ background:linear-gradient(150deg,var(--g1),var(--g2) 45%,var(--g3)); color:#fff; }

    .form-switch .form-check-input{ width:2.4em; height:1.2em; }

    /* Tabela */
    .cardx{ background:#fff; border-radius:18px; padding:14px; box-shadow:0 18px 42px rgba(14,56,110,.12); border:1px solid #e7f0fb; }
    .table thead th{ border-bottom:1px solid #e8f0ff; color:#173b61; }

    .pill{ border-radius:999px; padding:.25rem .6rem; font-weight:800; }
    .pill.ok{   background:#e8fff1; color:#18794e; border:1px solid #c8ffd9; }
    .pill.warn{ background:#fff4e3; color:#9a5c14; border:1px solid #ffd8a8; }
    .pill.bad{  background:#ffe3e3; color:#9a1f1f; border:1px solid #ffc4c4; }

    .codebox{
      border:1px dashed #cfe0f3; background:#f9fcff; border-radius:12px; padding:.7rem .8rem; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      word-break: break-all;
    }
    .qr-placeholder{
      width:160px; height:160px; border-radius:12px;
      background:
        repeating-linear-gradient(0deg, #000 0 8px, #fff 8px 16px),
        repeating-linear-gradient(90deg, #000 0 8px, #fff 8px 16px);
      mix-blend-mode: multiply; box-shadow:0 16px 32px rgba(0,0,0,.12);
    }

    /* Barra flutuante de seleção */
    .bulkbar{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; z-index:1080; display:none;
      background:#ffffffee; backdrop-filter: blur(8px);
      border:1px solid #e7f0fb; border-radius:999px; padding:.4rem .6rem;
      box-shadow:0 18px 36px rgba(0,0,0,.16);
    }
    .bulkbar.show{ display:flex; align-items:center; gap:8px; }
    .bulk-count{ font-weight:900; color:#0b5ed7; padding:.35rem .7rem; background:#e9f2ff; border-radius:999px; }
  </style>
</head>
<body>

  <!-- Botão fixo -->
  <button id="af-launcher" class="corner-launcher" type="button" aria-label="Abrir menu">
    <img src="af-badge.png" alt="AFUJF" class="af-badge">
  </button>

  <!-- Navbar lateral (ADMIN) -->
  <div class="offcanvas offcanvas-start offcanvas-afujf" tabindex="-1" id="menuAFUJF" aria-labelledby="menuAFUJFLabel">
    <div class="offcanvas-header align-items-center">
      <div class="d-flex align-items-center gap-3">
        <img src="af-badge.png" alt="AFUJF" class="brand-badge-img">
        <div>
          <img id="menuAFUJFLabel" src="afujf.png" alt="AFUJF" class="brand-title-img">
          <small class="opacity-75">Administração</small>
        </div>
      </div>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>

    <div class="offcanvas-body d-flex flex-column">
      <ul class="menu-list">
        <li><a class="menu-link" href="admin-home.html"><i class="bi bi-speedometer2"></i> Home</a></li>
        <li><a class="menu-link" href="admin-associados.html"><i class="bi bi-people"></i> Associados</a></li>
        <li><a class="menu-link" href="admin-convenios.html"><i class="bi bi-bag-heart"></i> Convênios</a></li>
        <li><a class="menu-link" href="admin-eventos.html"><i class="bi bi-calendar-event"></i> Eventos</a></li>
        <li><a class="menu-link active" href="admin-faturamento.html"><i class="bi bi-receipt"></i> Faturamento</a></li>
      </ul>

      <div class="menu-divider"></div>
      <div class="mt-auto admin-block">
        <div class="d-flex align-items-center gap-2">
          <div class="admin-badge"><i class="bi bi-shield-lock"></i></div>
          <div>
            <div class="fw-semibold">Administrador</div>
            <small class="opacity-75">Painel AFUJF</small>
          </div>
        </div>
        <button class="btn btn-outline-light btn-sm px-3" type="button">
          <i class="bi bi-box-arrow-right me-1"></i> Sair
        </button>
      </div>
    </div>
  </div>

  <!-- CONTEÚDO -->
  <main class="container-narrow">
    <!-- Hero -->
    <header class="hero">
      <div class="hero-chip"><i class="bi bi-receipt"></i></div>
      <div>
        <h1>Faturamento</h1>
        <small>Gere, concilie e acompanhe as faturas da AFUJF.</small>
      </div>
    </header>

    <!-- KPIs -->
    <section class="kpi-grid">
      <div class="kpi"><div class="kpi-ico"><i class="bi bi-file-earmark-text"></i></div><div><div class="kpi-val" id="kpiEmitidas">0</div><div class="kpi-sub">Emitidas (mês)</div></div></div>
      <div class="kpi"><div class="kpi-ico"><i class="bi bi-check2-circle"></i></div><div><div class="kpi-val" id="kpiPagas">0</div><div class="kpi-sub">Pagas (mês)</div></div></div>
      <div class="kpi"><div class="kpi-ico"><i class="bi bi-hourglass-split"></i></div><div><div class="kpi-val" id="kpiAberto">0</div><div class="kpi-sub">Em aberto (mês)</div></div></div>
      <div class="kpi"><div class="kpi-ico"><i class="bi bi-exclamation-triangle"></i></div><div><div class="kpi-val" id="kpiAtrasadas">0</div><div class="kpi-sub">Atrasadas (mês)</div></div></div>
      <div class="kpi"><div class="kpi-ico"><i class="bi bi-cash-coin"></i></div><div><div class="kpi-val" id="kpiReceita">R$ 0,00</div><div class="kpi-sub">Receita do mês</div></div></div>
      <div class="kpi"><div class="kpi-ico"><i class="bi bi-graph-down-arrow"></i></div><div><div class="kpi-val" id="kpiInad">0%</div><div class="kpi-sub">Inadimplência</div></div></div>
    </section>

    <!-- ===== TOOLBAR enxuta ===== -->
    <section class="toolbar">
      <!-- Header: busca + ações -->
      <div class="toolbar-header">
        <div class="search-wrap">
          <i class="bi bi-search"></i>
          <input id="busca" type="search" class="form-control search-input" placeholder="Buscar por Nº, associado, CPF…">
        </div>
        <div class="toolbar-actions">
          <button id="btnGerar" class="btn btn-grad btn-pill btn-lgx"><i class="bi bi-plus-lg me-1"></i> Gerar fatura</button>
          <button id="btnConciliar" class="btn btn-ghost btn-pill btn-lgx"><i class="bi bi-arrow-repeat me-1"></i> Conciliar</button>

          <div class="dropdown">
            <button class="btn btn-ghost btn-pill btn-icon" data-bs-toggle="dropdown" aria-expanded="false" title="Mais">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><button class="dropdown-item" id="btnImportar"><i class="bi bi-file-earmark-arrow-up me-2"></i>Importar CSV</button></li>
              <li><button class="dropdown-item" id="btnExportar"><i class="bi bi-file-earmark-arrow-down me-2"></i>Exportar CSV</button></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Abas de status -->
      <ul class="nav status-tabs" id="statusTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-status="" type="button">Todos <span class="badge bg-light text-dark ms-1" id="bdTodos">0</span></button></li>
        <li class="nav-item"><button class="nav-link" data-status="Em Aberto" type="button">Em aberto <span class="badge bg-light text-dark ms-1" id="bdAberto">0</span></button></li>
        <li class="nav-item"><button class="nav-link" data-status="Paga" type="button">Pagas <span class="badge bg-light text-dark ms-1" id="bdPagas">0</span></button></li>
        <li class="nav-item"><button class="nav-link" data-status="Atrasada" type="button">Atrasadas <span class="badge bg-light text-dark ms-1" id="bdAtras">0</span></button></li>
        <li class="nav-item"><button class="nav-link" data-status="Cancelada" type="button">Canceladas <span class="badge bg-light text-dark ms-1" id="bdCanc">0</span></button></li>
      </ul>

      <!-- Toggle filtros -->
      <div class="d-flex align-items-center justify-content-between">
        <button class="filters-toggle btn-pill" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false">
          <i class="bi bi-chevron-down"></i> Mais filtros
        </button>
        <!-- Campos ocultos para reaproveitar lógica -->
        <input type="hidden" id="statusFiltro" value="">
        <input type="hidden" id="metodoFiltro" value="">
        <input id="fileInput" type="file" accept=".csv" class="d-none">
      </div>

      <!-- Corpo filtros -->
      <div id="filtersCollapse" class="collapse">
        <div class="filters-body mt-2">
          <div>
            <label class="form-label small text-muted mb-1">Competência</label>
            <input id="competenciaFiltro" type="month" class="form-control btn-pill">
          </div>

          <div>
            <label class="form-label small text-muted mb-1">Método</label><br>
            <div class="segmented" id="metodoSegment">
              <div class="seg" data-metodo="PIX"><i class="bi bi-lightning-charge me-1"></i>PIX</div>
              <div class="seg" data-metodo="Boleto"><i class="bi bi-upc me-1"></i>Boleto</div>
            </div>
            <button id="clearMetodo" class="btn btn-ghost btn-pill btn-mdx ms-2 align-baseline"><i class="bi bi-x-circle me-1"></i> Limpar</button>
          </div>

          <div class="form-check form-switch ms-lg-auto">
            <input class="form-check-input" type="checkbox" role="switch" id="onlyOverdue">
            <label class="form-check-label" for="onlyOverdue">Somente vencidas</label>
          </div>
        </div>
      </div>
    </section>

    <!-- LISTA -->
    <section class="cardx">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="width:38px;"><input id="selAll" class="form-check-input" type="checkbox"></th>
              <th>Nº</th>
              <th>Associado</th>
              <th>Competência</th>
              <th>Vencimento</th>
              <th>Valor</th>
              <th>Método</th>
              <th>Status</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ===== Barra flutuante de seleção ===== -->
  <div id="bulkbar" class="bulkbar">
    <span class="bulk-count" id="bulkCount">0</span>
    <button class="btn btn-grad btn-pill btn-mdx" id="actMarkPaid"><i class="bi bi-cash-coin me-1"></i> Marcar pagas</button>
    <button class="btn btn-ghost btn-pill btn-mdx" id="actCancel"><i class="bi bi-x-circle me-1"></i> Cancelar</button>
    <button class="btn btn-ghost btn-pill btn-mdx" id="actExportSel"><i class="bi bi-filetype-csv me-1"></i> Exportar</button>
    <button class="btn btn-ghost btn-pill btn-icon" id="actCloseBulk" title="Fechar"><i class="bi bi-x-lg"></i></button>
  </div>

  <!-- MODAIS (Gerar / Pagamento / Cobrança / Cancelar) -->
  <div class="modal fade" id="modalGerar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background: linear-gradient(180deg, #f7fbff 0%, #ecf4ff 100%);">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-plus me-2"></i>Gerar fatura</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-12">
              <label class="form-label">Associado *</label>
              <select id="gAssociado" class="form-select"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Competência *</label>
              <input id="gCompet" type="month" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Vencimento *</label>
              <input id="gVenc" type="date" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Valor (R$) *</label>
              <input id="gValor" type="number" min="0" step="0.01" class="form-control" placeholder="148,90">
            </div>
            <div class="col-md-6">
              <label class="form-label">Método</label>
              <select id="gMetodo" class="form-select">
                <option>PIX</option>
                <option>Boleto</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Observações</label>
              <input id="gObs" class="form-control" placeholder="Opcional">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost btn-pill btn-mdx" data-bs-dismiss="modal">Cancelar</button>
          <button id="saveGerar" class="btn btn-grad btn-pill btn-mdx">Gerar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalPgto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background: linear-gradient(180deg, #f7fbff 0%, #ecf4ff 100%);">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i>Registrar pagamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-12"><div id="pgtoResumo" class="small text-muted">—</div></div>
            <div class="col-md-6">
              <label class="form-label">Data do pagamento</label>
              <input id="pData" type="date" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Método</label>
              <select id="pMetodo" class="form-select">
                <option>PIX</option>
                <option>Boleto</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Valor (R$)</label>
              <input id="pValor" type="number" step="0.01" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Observações</label>
              <input id="pObs" class="form-control" placeholder="Opcional">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost btn-pill btn-mdx" data-bs-dismiss="modal">Fechar</button>
          <button id="savePgto" class="btn btn-grad btn-pill btn-mdx">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalCobranca" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="background: linear-gradient(180deg, #f7fbff 0%, #ecf4ff 100%);">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Detalhes da cobrança</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div id="cobrancaConteudo">—</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost btn-pill btn-mdx" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalCancel" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background: linear-gradient(180deg, #f7fbff 0%, #ecf4ff 100%);">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-x-circle me-2"></i>Cancelar fatura</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">Tem certeza que deseja cancelar a fatura <strong id="cancelNum">—</strong>?</div>
        <div class="modal-footer">
          <button class="btn btn-ghost btn-pill btn-mdx" data-bs-dismiss="modal">Fechar</button>
          <button id="confirmCancel" class="btn btn-grad btn-pill btn-mdx">Cancelar fatura</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="toastOK" class="toast align-items-center text-bg-success border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Ação concluída.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (() => {
      /* ===== Offcanvas ===== */
      const launcher = document.getElementById('af-launcher');
      const offEl = document.getElementById('menuAFUJF');
      const off = bootstrap.Offcanvas.getOrCreateInstance(offEl, { backdrop:true, scroll:true, keyboard:true });
      launcher.addEventListener('click', e => { e.preventDefault(); off.toggle(); });
      offEl.addEventListener('show.bs.offcanvas',  () => launcher.classList.add('hidden'));
      offEl.addEventListener('hidden.bs.offcanvas', () => launcher.classList.remove('hidden'));
      document.querySelectorAll('.menu-link').forEach(a => a.addEventListener('click', () => off.hide()));

      /* ===== Utils ===== */
      const money = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
      const todayISO = () => new Date().toISOString().slice(0,10);
      const thisMonth = () => new Date().toISOString().slice(0,7);
      const toast = new bootstrap.Toast(document.getElementById('toastOK'), { delay: 2000 });
      const toastMsg = msg => { document.querySelector('#toastOK .toast-body').textContent = msg; toast.show(); };

      /* ===== Refs ===== */
      const tbody = document.getElementById('tbody');
      const busca = document.getElementById('busca');
      const competenciaFiltro = document.getElementById('competenciaFiltro');
      const statusFiltro = document.getElementById('statusFiltro');
      const metodoFiltro = document.getElementById('metodoFiltro');
      const onlyOverdue = document.getElementById('onlyOverdue');

      const statusTabs = document.getElementById('statusTabs');
      const bdTodos = document.getElementById('bdTodos');
      const bdAberto = document.getElementById('bdAberto');
      const bdPagas = document.getElementById('bdPagas');
      const bdAtras = document.getElementById('bdAtras');
      const bdCanc  = document.getElementById('bdCanc');

      const selAll = document.getElementById('selAll');

      const btnGerar = document.getElementById('btnGerar');
      const btnConciliar = document.getElementById('btnConciliar');
      const btnImportar = document.getElementById('btnImportar');
      const btnExportar = document.getElementById('btnExportar');
      const fileInput = document.getElementById('fileInput');

      // Bulkbar
      const bulkbar = document.getElementById('bulkbar');
      const bulkCount = document.getElementById('bulkCount');
      const actMarkPaid = document.getElementById('actMarkPaid');
      const actCancel = document.getElementById('actCancel');
      const actExportSel = document.getElementById('actExportSel');
      const actCloseBulk = document.getElementById('actCloseBulk');

      // Segmento método
      const metodoSegment = document.getElementById('metodoSegment');
      const clearMetodo = document.getElementById('clearMetodo');

      // Modais
      const modalGerar = new bootstrap.Modal(document.getElementById('modalGerar'));
      const modalPgto  = new bootstrap.Modal(document.getElementById('modalPgto'));
      const modalCobr  = new bootstrap.Modal(document.getElementById('modalCobranca'));
      const modalCanc  = new bootstrap.Modal(document.getElementById('modalCancel'));

      // Form Gerar
      const gAssociado = document.getElementById('gAssociado');
      const gCompet = document.getElementById('gCompet');
      const gVenc = document.getElementById('gVenc');
      const gValor = document.getElementById('gValor');
      const gMetodo = document.getElementById('gMetodo');

      // Form Pgto
      const pgtoResumo = document.getElementById('pgtoResumo');
      const pData = document.getElementById('pData');
      const pMetodo = document.getElementById('pMetodo');
      const pValor = document.getElementById('pValor');

      // Cobrança
      const cobrancaConteudo = document.getElementById('cobrancaConteudo');

      /* ===== Dados (mock) ===== */
      let seq = 5000;
      const associados = [
        {id:1, nome:'Nome Sobrenome', cpf:'102.100.473-32', mensalidade:148.90},
        {id:2, nome:'João Silva',     cpf:'111.222.333-44', mensalidade:148.90},
        {id:3, nome:'Maria Souza',    cpf:'555.666.777-88', mensalidade:159.90},
        {id:4, nome:'Carlos Lima',    cpf:'999.888.777-66', mensalidade:148.90},
      ];
      let faturas = [
        {id:++seq, numero:'2025-09-0001', associadoId:1, associado:'Nome Sobrenome', cpf:'102.100.473-32', competencia:'2025-09', venc:'2025-09-10', valor:148.90, metodo:'Boleto', status:'Em Aberto', linha:'23790.00009 00000.000000 00000.000000 0 00000000000000', txid:''},
        {id:++seq, numero:'2025-09-0002', associadoId:2, associado:'João Silva',     cpf:'111.222.333-44', competencia:'2025-09', venc:'2025-09-10', valor:148.90, metodo:'PIX',    status:'Paga',      linha:'', txid:'PIX-ABCD1234-0002'},
        {id:++seq, numero:'2025-09-0003', associadoId:3, associado:'Maria Souza',    cpf:'555.666.777-88', competencia:'2025-09', venc:'2025-09-10', valor:159.90, metodo:'PIX',    status:'Em Aberto', linha:'', txid:'PIX-ABCD1234-0003'},
        {id:++seq, numero:'2025-08-0044', associadoId:4, associado:'Carlos Lima',    cpf:'999.888.777-66', competencia:'2025-08', venc:'2025-08-10', valor:148.90, metodo:'Boleto', status:'Atrasada',  linha:'23790.00009 00000.000000 00000.000000 0 00000000000000', txid:''},
      ];

      /* ===== Helpers ===== */
      function ensureOverdueFlags(){
        const today = new Date(todayISO());
        faturas.forEach(f=>{
          if(['Paga','Cancelada'].includes(f.status)) return;
          const due = new Date(f.venc+'T00:00:00');
          if(due < today && f.status !== 'Atrasada') f.status = 'Atrasada';
          if(due >= today && f.status === 'Atrasada') f.status = 'Em Aberto';
        });
      }

      function updateKPIs(){
        const comp = competenciaFiltro.value || thisMonth();
        const monthList = faturas.filter(f=>f.competencia===comp);
        const emitidas = monthList.length;
        const pagas = monthList.filter(f=>f.status==='Paga').length;
        const aberto = monthList.filter(f=>f.status==='Em Aberto' || f.status==='Gerada').length;
        const atras = monthList.filter(f=>f.status==='Atrasada').length;
        const receita = monthList.filter(f=>f.status==='Paga').reduce((s,f)=> s + (f.valor||0), 0);
        const inadPerc = emitidas ? Math.round(((aberto+atras)/emitidas)*100) : 0;

        document.getElementById('kpiEmitidas').textContent = emitidas.toLocaleString('pt-BR');
        document.getElementById('kpiPagas').textContent    = pagas.toLocaleString('pt-BR');
        document.getElementById('kpiAberto').textContent   = aberto.toLocaleString('pt-BR');
        document.getElementById('kpiAtrasadas').textContent= atras.toLocaleString('pt-BR');
        document.getElementById('kpiReceita').textContent  = money(receita);
        document.getElementById('kpiInad').textContent     = inadPerc + '%';

        // Abas de status (contadores)
        bdTodos.textContent = emitidas;
        bdAberto.textContent= aberto;
        bdPagas.textContent = pagas;
        bdAtras.textContent = atras;
        bdCanc.textContent  = monthList.filter(f=>f.status==='Cancelada').length;
      }

      function renderTable(){
        ensureOverdueFlags();

        const q = busca.value.trim().toLowerCase();
        const comp = competenciaFiltro?.value || '';
        const st = statusFiltro.value;
        const mt = metodoFiltro.value;
        const onlyVenc = onlyOverdue.checked;

        const list = faturas.filter(f=>{
          const txt = `${f.numero} ${f.associado} ${f.cpf}`.toLowerCase();
          const okQ = !q || txt.includes(q);
          const okC = !comp || f.competencia===comp;
          const okS = !st || f.status===st;
          const okM = !mt || f.metodo===mt;
          const okV = !onlyVenc || (new Date(f.venc+'T00:00:00') < new Date(todayISO()) && !['Paga','Cancelada'].includes(f.status));
          return okQ && okC && okS && okM && okV;
        });

        tbody.innerHTML = '';
        list.forEach(f=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input class="form-check-input selRow" data-id="${f.id}" type="checkbox"></td>
            <td class="fw-semibold">${f.numero}</td>
            <td>
              <div class="fw-bold">${f.associado}</div>
              <div class="text-muted small">${f.cpf}</div>
            </td>
            <td>${f.competencia}</td>
            <td>${new Date(f.venc+'T00:00:00').toLocaleDateString('pt-BR')}</td>
            <td><strong>${money(f.valor)}</strong></td>
            <td>${f.metodo}</td>
            <td>
              <span class="pill ${f.status==='Paga'?'ok':(f.status==='Atrasada'?'bad':(f.status==='Cancelada'?'bad':'warn'))}">${f.status}</span>
            </td>
            <td class="text-end">
              <button class="btn btn-ghost btn-pill btn-mdx me-1" data-role="ver" data-id="${f.id}" title="Ver cobrança"><i class="bi bi-eye"></i></button>
              ${f.status!=='Paga' && f.status!=='Cancelada' ? `<button class="btn btn-grad btn-pill btn-mdx me-1" data-role="pgto" data-id="${f.id}" title="Registrar pagamento"><i class="bi bi-cash-coin"></i></button>`:''}
              ${f.status!=='Paga' && f.status!=='Cancelada' ? `<button class="btn btn-ghost btn-pill btn-mdx" data-role="cancel" data-id="${f.id}" title="Cancelar"><i class="bi bi-x-circle"></i></button>`:''}
            </td>
          `;
          tbody.appendChild(tr);
        });

        selAll.checked = false;
        updateBulkbar();
        updateKPIs();
      }

      /* ===== Popular selects ===== */
      function populateAssociados(){
        gAssociado.innerHTML = associados.map(a=>`<option value="${a.id}" data-cpf="${a.cpf}" data-mensal="${a.mensalidade}">${a.nome} • ${a.cpf}</option>`).join('');
      }

      /* ===== Filtros e eventos ===== */
      ['input','change'].forEach(evt=>{
        busca.addEventListener(evt, renderTable);
        onlyOverdue.addEventListener(evt, renderTable);
      });

      // Abas de status
      statusTabs.addEventListener('click', (e)=>{
        const btn = e.target.closest('.nav-link'); if(!btn) return;
        statusTabs.querySelectorAll('.nav-link').forEach(n=> n.classList.remove('active'));
        btn.classList.add('active');
        statusFiltro.value = btn.dataset.status || '';
        renderTable();
      });

      // Competência
      if (competenciaFiltro) competenciaFiltro.addEventListener('change', renderTable);

      // Segmento método
      metodoSegment.addEventListener('click', (e)=>{
        const seg = e.target.closest('.seg'); if(!seg) return;
        const val = seg.dataset.metodo;
        metodoSegment.querySelectorAll('.seg').forEach(s=> s.classList.remove('active'));
        if(metodoFiltro.value === val){
          metodoFiltro.value = '';
        }else{
          seg.classList.add('active');
          metodoFiltro.value = val;
        }
        renderTable();
      });
      clearMetodo.addEventListener('click', ()=>{
        metodoFiltro.value = '';
        metodoSegment.querySelectorAll('.seg').forEach(s=> s.classList.remove('active'));
        renderTable();
      });

      // Seleção (bulkbar)
      selAll.addEventListener('change', ()=>{
        document.querySelectorAll('.selRow').forEach(c=> c.checked = selAll.checked );
        updateBulkbar();
      });
      tbody.addEventListener('change', (e)=>{
        if(e.target.classList.contains('selRow')) updateBulkbar();
      });
      function getSelectedIds(){ return [...document.querySelectorAll('.selRow:checked')].map(c=> Number(c.dataset.id)); }
      function updateBulkbar(){
        const n = getSelectedIds().length;
        bulkCount.textContent = n;
        bulkbar.classList.toggle('show', n>0);
      }
      actCloseBulk.addEventListener('click', ()=>{
        document.querySelectorAll('.selRow').forEach(c=> c.checked = false);
        selAll.checked = false;
        updateBulkbar();
      });

      // Bulk actions
      actMarkPaid.addEventListener('click', ()=>{
        const ids = getSelectedIds(); if(!ids.length){ toastMsg('Selecione faturas.'); return; }
        let n=0; faturas.forEach(f=>{ if(ids.includes(f.id) && !['Paga','Cancelada'].includes(f.status)){ f.status='Paga'; n++; }});
        toastMsg(n?`Marcadas como pagas: ${n}`:'Nenhuma alterada.');
        renderTable();
      });
      actCancel.addEventListener('click', ()=>{
        const ids = getSelectedIds(); if(!ids.length){ toastMsg('Selecione faturas.'); return; }
        let n=0; faturas.forEach(f=>{ if(ids.includes(f.id) && !['Paga','Cancelada'].includes(f.status)){ f.status='Cancelada'; n++; }});
        toastMsg(n?`Canceladas: ${n}`:'Nenhuma cancelada.');
        renderTable();
      });
      actExportSel.addEventListener('click', ()=>{
        const ids = getSelectedIds(); if(!ids.length){ toastMsg('Selecione faturas.'); return; }
        exportCSV(faturas.filter(f=> ids.includes(f.id)));
      });

      /* ===== Gerar fatura ===== */
      btnGerar.addEventListener('click', ()=>{
        populateAssociados();
        gCompet.value = competenciaFiltro?.value || thisMonth();
        gVenc.value = (()=>{
          const [y,m] = (gCompet.value || thisMonth()).split('-');
          return `${y}-${m}-10`;
        })();
        const sel = associados.find(a=> a.id === Number(gAssociado.value));
        gValor.value = sel ? sel.mensalidade : 148.90;
        gMetodo.value = 'PIX';
        new bootstrap.Modal(document.getElementById('modalGerar')).show();
      });

      document.getElementById('saveGerar').addEventListener('click', ()=>{
        const assoc = associados.find(a=> a.id===Number(gAssociado.value));
        if(!assoc){ alert('Selecione um associado.'); return; }
        const comp = gCompet.value || thisMonth();
        const venc = gVenc.value || todayISO();
        const valor = parseFloat(gValor.value||0);
        const metodo = gMetodo.value;
        const numero = `${comp}-${String((faturas.filter(f=>f.competencia===comp).length+1)).padStart(4,'0')}`;
        const linha = metodo==='Boleto' ? '23790.00009 00000.000000 00000.000000 0 00000000000000' : '';
        const txid = metodo==='PIX' ? `PIX-${Math.random().toString(36).slice(2,10).toUpperCase()}-${Date.now().toString().slice(-4)}` : '';

        faturas.push({ id: ++seq, numero, associadoId:assoc.id, associado:assoc.nome, cpf:assoc.cpf,
          competencia: comp, venc, valor, metodo, status:'Em Aberto', linha, txid });

        bootstrap.Modal.getInstance(document.getElementById('modalGerar')).hide();
        toastMsg('Fatura gerada.');
        renderTable();
      });

      /* ===== Ver / Pagar / Cancelar (linha) ===== */
      tbody.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-role]');
        if(!btn) return;
        const id = Number(btn.dataset.id);
        const idx = faturas.findIndex(f=>f.id===id);
        if(idx<0) return;

        if(btn.dataset.role==='ver'){
          showCobranca(faturas[idx]);
        }
        if(btn.dataset.role==='pgto'){
          const f = faturas[idx];
          document.getElementById('pgtoResumo').textContent = `${f.numero} • ${f.associado} • ${money(f.valor)} • Venc: ${new Date(f.venc+'T00:00:00').toLocaleDateString('pt-BR')}`;
          document.getElementById('pData').value = todayISO();
          document.getElementById('pMetodo').value = f.metodo;
          document.getElementById('pValor').value = f.valor.toFixed(2);
          new bootstrap.Modal(document.getElementById('modalPgto')).show();
          // Confirmar
          document.getElementById('savePgto').onclick = ()=>{
            faturas[idx].status = 'Paga';
            bootstrap.Modal.getInstance(document.getElementById('modalPgto')).hide();
            toastMsg('Pagamento registrado.');
            renderTable();
          };
        }
        if(btn.dataset.role==='cancel'){
          document.getElementById('cancelNum').textContent = faturas[idx].numero;
          new bootstrap.Modal(document.getElementById('modalCancel')).show();
          document.getElementById('confirmCancel').onclick = ()=>{
            faturas[idx].status = 'Cancelada';
            bootstrap.Modal.getInstance(document.getElementById('modalCancel')).hide();
            toastMsg('Fatura cancelada.');
            renderTable();
          };
        }
      });

      function showCobranca(f){
        const cab = `<div class="mb-2"><strong>${f.associado}</strong> • ${f.cpf}<br><span class="text-muted small">Fatura ${f.numero} • ${f.metodo}</span></div>`;
        if(f.metodo==='PIX'){
          const copia = `000201010211...AFUJF|TXID=${f.txid}|VAL=${f.valor.toFixed(2)}|VENC=${f.venc}...`;
          cobrancaConteudo.innerHTML = `
            ${cab}
            <div class="d-flex flex-wrap align-items-start gap-3">
              <div class="qr-placeholder"></div>
              <div class="flex-grow-1">
                <div class="small text-muted mb-1">Copia e cola (PIX):</div>
                <div class="codebox mb-2" id="codeToCopy">${copia}</div>
                <button class="btn btn-ghost btn-pill btn-mdx" id="btnCopy"><i class="bi bi-clipboard"></i> Copiar código</button>
              </div>
            </div>
          `;
        }else{
          cobrancaConteudo.innerHTML = `
            ${cab}
            <div class="small text-muted mb-1">Linha digitável (Boleto):</div>
            <div class="codebox mb-2" id="codeToCopy">${f.linha || '—'}</div>
            <button class="btn btn-ghost btn-pill btn-mdx" id="btnCopy"><i class="bi bi-clipboard"></i> Copiar linha</button>
          `;
        }
        new bootstrap.Modal(document.getElementById('modalCobranca')).show();
        setTimeout(()=>{
          document.getElementById('btnCopy')?.addEventListener('click', ()=>{
            const txt = document.getElementById('codeToCopy').innerText;
            navigator.clipboard.writeText(txt);
            toastMsg(f.metodo==='PIX'?'Código PIX copiado.':'Linha digitável copiada.');
          });
        });
      }

      /* ===== Conciliação (demo) ===== */
      btnConciliar.addEventListener('click', ()=>{
        const today = new Date(todayISO());
        let hits = 0;
        faturas.forEach(f=>{
          if(f.metodo==='PIX' && f.txid && ['Em Aberto','Atrasada','Gerada'].includes(f.status)){
            const due = new Date(f.venc+'T00:00:00');
            if(due <= today) { f.status = 'Paga'; hits++; }
          }
        });
        toastMsg(hits ? `Conciliação: ${hits} pagamento(s) confirmado(s).` : 'Nada a conciliar.');
        renderTable();
      });

      /* ===== Importar/Exportar CSV ===== */
      btnImportar.addEventListener('click', ()=> fileInput.click());
      fileInput.addEventListener('change', ()=>{
        const f = fileInput.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          const text = reader.result;
          const rows = text.split(/\r?\n/).filter(l=>l.trim().length);
          if(!rows.length){ alert('Arquivo vazio.'); return; }
          const sep = rows[0].includes(';') ? ';' : ',';
          // numero,associado,cpf,competencia,venc,valor,metodo,status,linha,txid
          let imported=0;
          rows.slice(1).forEach(l=>{
            const c = l.split(sep).map(s=>s.trim());
            if(c.length<8) return;
            const [numero, associado, cpf, competencia, venc, valor, metodo, status, linha='', txid=''] = c;
            faturas.push({id:++seq, numero, associadoId:null, associado, cpf, competencia, venc, valor:parseFloat(valor.replace('.','').replace(',','.'))||0, metodo, status, linha, txid});
            imported++;
          });
          toastMsg(`Importação concluída: ${imported} fatura(s).`);
          renderTable();
          fileInput.value='';
        };
        reader.readAsText(f, 'utf-8');
      });

      function exportCSV(list){
        const header = ['numero','associado','cpf','competencia','venc','valor','metodo','status','linha','txid'];
        const lines = [header.join(',')];
        list.forEach(f=>{
          const row = [
            `"${f.numero}"`,`"${(f.associado||'').replace(/"/g,'""')}"`,`"${f.cpf||''}"`
            ,f.competencia, f.venc, (f.valor||0).toString().replace('.',','), f.metodo, f.status,
            `"${f.linha||''}"`,`"${f.txid||''}"`
          ];
          lines.push(row.join(','));
        });
        const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'faturas_afujf.csv'; a.click();
        URL.revokeObjectURL(url);
      }
      btnExportar?.addEventListener('click', ()=> exportCSV(faturas));

      /* ===== Init ===== */
      if(competenciaFiltro) competenciaFiltro.value = thisMonth();
      renderTable();
    })();
  </script>
</body>
</html>
