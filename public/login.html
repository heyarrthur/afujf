<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AFUJF • Login</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{
      --g1:#12c26d; --g2:#0ea5a7; --g3:#1366d6;
      --ink:#0c3a62; --muted:#6b82a3;
    }
    body{
      min-height:100vh; display:grid; place-items:center;
      background: radial-gradient(1200px 600px at 100% -10%, #0ea5a729, transparent 60%),
                  radial-gradient(1200px 600px at -10% -10%, #12c26d29, transparent 60%),
                  linear-gradient(180deg,#f7fbff 0%,#eaf3ff 100%);
    }
    .shell{ max-width:1024px; width:100%; padding:20px; }
    .cardx{ border:1px solid #e7f0fb; border-radius:20px; background:#fff; box-shadow:0 18px 42px rgba(14,56,110,.10); }
    .left{
      padding:26px; background:linear-gradient(160deg, var(--g1) 0%, var(--g2) 45%, var(--g3) 100%);
      border-radius:18px; color:#fff; height:100%;
    }
    .left .logo{
      width:72px; height:72px; border-radius:50%; display:grid; place-items:center; font-size:1.6rem; font-weight:900;
      background:rgba(255,255,255,.15); box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }
    .left h1{ font-weight:900; margin:16px 0 4px; }
    .left p{ opacity:.92; margin:0; }
    .perks{ list-style:none; padding:0; margin:18px 0 0; }
    .perks li{ display:flex; align-items:center; gap:.6rem; margin:.5rem 0; }
    .perks i{ width:28px; height:28px; display:grid; place-items:center; border-radius:8px; background:rgba(255,255,255,.14); }
    .right{ padding:26px; }
    .brand-min{ display:none; }
    @media (max-width: 991px){ .brand-min{ display:flex; align-items:center; gap:.6rem; margin-bottom:8px; } }

    .form-label{ font-weight:700; color:var(--ink); }
    .btn-primary{
      background:linear-gradient(150deg,var(--g1),var(--g2) 45%,var(--g3)); border:0;
      box-shadow:0 10px 22px rgba(19,102,214,.20);
    }
    .btn-primary:disabled{ opacity:.8; }
    .muted{ color:var(--muted); }
    .alert-dock{ min-height:40px; }
    .mini{
      display:flex; gap:.6rem; margin-top:14px;
    }
    .mini .card{ flex:1; border-radius:14px; border-color:#e7f0fb; }
    .mini .card .icon{
      width:36px; height:36px; border-radius:10px; display:grid; place-items:center; color:#fff;
      background:linear-gradient(150deg,var(--g1),var(--g2) 45%,var(--g3));
    }
  </style>
</head>
<body>
  <main class="shell">
    <div class="row g-3 align-items-stretch">
      <!-- Card 1: Destaque / Branding -->
      <div class="col-lg-6">
        <div class="cardx h-100">
          <div class="left h-100">
            <div class="logo">AF</div>
            <h1>Bem-vindo à AFUJF</h1>
            <p>Acesse o painel administrativo ou a área do associado.</p>
            <ul class="perks">
              <li><i class="bi bi-shield-check"></i> Autenticação segura com JWT</li>
              <li><i class="bi bi-people"></i> Gestão de associados</li>
              <li><i class="bi bi-bag-heart"></i> Convênios e benefícios</li>
              <li><i class="bi bi-receipt"></i> Faturamento simplificado</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Card 2: Formulário de Login -->
      <div class="col-lg-6">
        <div class="cardx h-100">
          <div class="right">
            <div class="brand-min">
              <div class="logo" style="width:48px;height:48px;font-size:1.2rem;">AF</div>
              <div class="muted">Acesso ao painel</div>
            </div>

            <div id="loginError" class="alert alert-danger d-none alert-dock"></div>

            <form id="loginForm" autocomplete="on" novalidate>
              <div class="mb-3">
                <label class="form-label">Matrícula</label>
                <input id="matricula" class="form-control" placeholder="9999999-9999" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Senha</label>
                <input id="senha" type="password" class="form-control" placeholder="Sua senha" required>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="remember">
                  <label class="form-check-label muted" for="remember">Manter conectado</label>
                </div>
                <a class="small text-decoration-none" href="#" onclick="alert('Fale com o administrador para redefinir a senha.')">Esqueceu a senha?</a>
              </div>
              <button id="btnEntrar" class="btn btn-primary w-100" type="submit">
                <i class="bi bi-box-arrow-in-right me-1"></i> Entrar
              </button>
            </form>

            <!-- 2 mini cards informativos -->
            <div class="mini">
              <div class="card p-3">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <div class="icon"><i class="bi bi-person-lock"></i></div>
                  <strong>Admin</strong>
                </div>
                <div class="small muted">Use a matrícula do admin para acessar o painel administrativo.</div>
              </div>
              <div class="card p-3">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <div class="icon"><i class="bi bi-person-vcard"></i></div>
                  <strong>Associado</strong>
                </div>
                <div class="small muted">Associados acessam a área do usuário com sua matrícula.</div>
              </div>
            </div>

            <div id="loginStatus" class="small muted mt-3"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Script inline do login -->
  <script>
    (function(){
      "use strict";
      const $ = (s, r=document) => r.querySelector(s);

      const form   = $("#loginForm");
      const inpMat = $("#matricula");
      const inpPwd = $("#senha");
      const btn    = $("#btnEntrar");
      const boxErr = $("#loginError");
      const status = $("#loginStatus");

      function showErr(msg){ if(boxErr){ boxErr.textContent = msg; boxErr.classList.remove("d-none"); } else alert(msg); }
      function clearErr(){ boxErr?.classList.add("d-none"); }
      function setStatus(msg){ if(status) status.textContent = msg || ""; }

      // Escreve cookie para o back poder ler se necessário
      function setCookie(name, value, hours){
        try{
          const d = new Date(); d.setTime(d.getTime() + (hours*60*60*1000));
          document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + d.toUTCString() + ";path=/";
        }catch{}
      }

      function go(role, matricula){
        const dest = (String(role).toLowerCase() === "admin") ? "/admin/home.html" : "/public/dashboard.html";
        window.location.replace(dest);
      }

      async function doLogin(e){
        e?.preventDefault();
        clearErr(); setStatus("");

        const matricula = (inpMat?.value || "").trim();
        const senha     = (inpPwd?.value || "").trim();
        if (!matricula || !senha) return showErr("Informe matrícula e senha.");

        btn && (btn.disabled = true);
        setStatus("Entrando…");

        try{
          const r = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Accept": "application/json" },
            body: JSON.stringify({ matricula, senha })
          });

          const ct = r.headers.get("content-type") || "";
          const data = ct.includes("application/json") ? await r.json() : {};

          if (!r.ok) {
            showErr(data?.error || "Credenciais inválidas");
            return;
          }

          // Guarda token tanto no localStorage quanto em cookie
          localStorage.setItem("token", data.token);
          localStorage.setItem("session", JSON.stringify({ role: data.user?.role, matricula: data.user?.matricula }));
          setCookie("token", data.token, 8);

          go(data.user?.role, data.user?.matricula);
        } catch (err) {
          showErr("Erro de rede ao logar. Verifique o servidor.");
        } finally {
          btn && (btn.disabled = false);
          setStatus("");
        }
      }

      // Liga eventos
      form?.addEventListener("submit", doLogin);
      btn?.addEventListener("click", (e)=>{ if(!form) doLogin(e); });
      [inpMat, inpPwd].forEach(el => el && el.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") doLogin(ev); }));
    })();
  </script>
</body>
</html>
